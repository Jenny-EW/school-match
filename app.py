from flask import Flask, render_template, request, redirect, url_for
import sqlite3
import random
import os

app = Flask(__name__)

def init_db():
    conn = sqlite3.connect('school_match.db')
    c = conn.cursor()

    c.execute('''
    CREATE TABLE IF NOT EXISTS dimensions
    (id INTEGER PRIMARY KEY AUTOINCREMENT,
     name TEXT NOT NULL,
     desc TEXT NOT NULL)
    ''')

    c.execute('SELECT COUNT(*) FROM dimensions')
    if c.fetchone()[0] == 0:
        dimensions = [
            ("学术严谨度", "对知识的深度钻研、逻辑严谨、重视理论基础"),
            ("创新创造力", "敢于突破常规、跨界思考、热衷新技术、新想法"),
            ("社交协作力", "擅长团队合作、沟通表达、跨文化交流"),
            ("实践落地力", "重视解决实际问题、动手能力、产学研结合"),
            ("人文素养", "关注社会议题、文化包容、人文关怀")
        ]
        c.executemany('INSERT INTO dimensions (name, desc) VALUES (?,?)', dimensions)

    c.execute('DROP TABLE IF EXISTS questions')
    c.execute('''
    CREATE TABLE questions
    (id INTEGER PRIMARY KEY AUTOINCREMENT,
     content TEXT NOT NULL,
     options TEXT NOT NULL)
    ''')

    questions = [
        ("学习时你更习惯？", "按计划一步步学，严谨认真|5|1|1|2|1|喜欢新奇方法，边玩边学|1|5|2|2|1|和同学一起讨论着学|2|1|5|1|1|动手实操，边做边学|1|2|1|5|1"),
        ("周末你更想怎么过？", "安静看书、自我提升|5|1|1|1|2|尝试新鲜事物、新爱好|1|5|1|2|1|和朋友聚会、出去玩|1|1|5|1|1|动手整理、做实事|1|1|1|5|1"),
        ("遇到难题你第一反应是？", "查资料，把逻辑理清楚|5|1|1|1|1|想个新奇办法试试看|1|5|1|2|1|找朋友一起商量|1|2|5|1|1|直接动手试错解决|1|1|1|5|1"),
        ("你更喜欢的课堂是？", "理论扎实、逻辑清晰|5|1|1|1|1|脑洞大、创意多|1|5|1|1|1|互动多、小组讨论多|1|1|5|1|1|实践多、能动手操作|1|1|1|5|1"),
        ("选地方出去玩，你优先？", "安静的书店、展览馆|5|1|1|1|3|创意市集、潮玩店|1|5|1|1|2|热闹商圈、和人扎堆|1|1|5|1|1|实用场所、体验生活|1|1|1|5|1"),
        ("你在团队里更像？", "把控细节、严谨靠谱|5|1|1|2|1|出点子、脑洞担当|1|5|1|1|1|协调大家、活跃气氛|1|1|5|1|1|负责执行、落地完成|1|1|1|5|1"),
        ("旅行时你会？", "做好详细攻略，按计划走|5|1|1|1|1|随性出发，偶遇惊喜|1|5|1|1|2|结伴而行，热热闹闹|1|1|5|1|1|体验当地生活，动手参与|1|1|1|5|2"),
        ("你更欣赏哪类人？", "学识渊博、逻辑强|5|1|1|1|2|脑洞大、有创意|1|5|1|1|1|人缘好、会沟通|1|1|5|1|2|动手强、踏实能干|1|1|1|5|1"),
        ("对未来你更看重？", "学术厉害、专业够深|5|1|1|1|1|能创新、做不一样的事|1|5|1|1|1|人脉广、人际舒服|1|1|5|1|2|踏实落地、解决问题|1|1|1|5|1"),
        ("选专业你最先看？", "专业硬核、学术强|5|1|1|1|1|新颖前沿、够创意|1|5|1|1|1|交流多、人脉广|1|1|5|1|1|实用性强、好就业|1|1|1|5|1"),
        ("你更喜欢的环境是？", "安静学术、氛围浓厚|5|1|1|1|2|自由创新、不受束缚|1|5|1|1|2|多元热闹、人际活跃|1|1|5|1|2|务实高效、方便动手|1|1|1|5|1"),
        ("你的做事风格？", "严谨细致，不出错|5|1|1|1|1|大胆尝试，不怕新|1|5|1|1|1|喜欢合作，爱沟通|1|1|5|1|1|务实肯干，重结果|1|1|1|5|1"),
        ("你更关注什么？", "知识原理、底层逻辑|5|1|1|1|1|新鲜事物、潮流创意|1|5|1|1|2|人际关系、情感交流|1|1|5|1|3|实际生活、实用技能|1|1|1|5|1"),
        ("收到别人建议，你会？", "理性分析，严谨判断|5|1|1|1|1|结合创意，灵活调整|1|5|1|1|1|多听意见，再做决定|1|1|5|1|2|直接实操，看效果|1|1|1|5|1"),
        ("你理想的校园氛围是？", "学术浓厚、治学严谨|5|1|1|1|2|创新自由、敢想敢做|1|5|1|1|2|多元包容、社交丰富|1|1|5|1|3|实践为主、产学结合|1|1|1|5|1")
    ]
    c.executemany('INSERT INTO questions (content, options) VALUES (?,?)', questions)

    c.execute('DROP TABLE IF EXISTS qs_schools')
    c.execute('''
    CREATE TABLE qs_schools
    (id INTEGER PRIMARY KEY AUTOINCREMENT,
     rank INTEGER NOT NULL,
     name TEXT NOT NULL,
     country TEXT NOT NULL,
     dimensions TEXT NOT NULL)
    ''')

    qs_schools = [
        (1, "麻省理工学院 (MIT)", "美国", "4|5|3|5|2"),
        (2, "帝国理工学院", "英国", "5|4|2|5|2"),
        (3, "斯坦福大学", "美国", "4|5|4|5|3"),
        (4, "牛津大学", "英国", "5|2|3|2|5"),
        (5, "哈佛大学", "美国", "5|3|4|3|5"),
        (6, "剑桥大学", "英国", "5|3|2|3|4"),
        (7, "苏黎世联邦理工学院", "瑞士", "5|4|2|5|1"),
        (8, "新加坡国立大学", "新加坡", "4|3|5|4|3"),
        (9, "伦敦大学学院", "英国", "4|4|4|3|4"),
        (10, "加州理工学院", "美国", "5|5|1|4|1"),
        (11, "香港大学", "中国香港特别行政区", "4|3|5|4|3"),
        (12, "南洋理工大学", "新加坡", "4|4|4|5|2"),
        (13, "芝加哥大学", "美国", "5|3|2|2|5"),
        (14, "北京大学", "中国内地", "5|2|3|3|4"),
        (15, "宾夕法尼亚大学", "美国", "4|4|4|4|4"),
        (16, "康奈尔大学", "美国", "4|3|4|4|3"),
        (17, "清华大学", "中国内地", "4|4|3|5|2"),
        (18, "加利福尼亚大学伯克利分校", "美国", "4|5|4|5|3"),
        (19, "墨尔本大学", "澳大利亚", "4|2|5|3|4"),
        (20, "新南威尔士大学", "澳大利亚", "4|3|4|4|3"),
        (21, "耶鲁大学", "美国", "4|2|4|2|5"),
        (22, "洛桑联邦理工学院", "瑞士", "5|4|2|5|1"),
        (23, "慕尼黑工业大学", "德国", "5|4|2|5|2"),
        (24, "约翰斯・霍普金斯大学", "美国", "5|3|3|4|4"),
        (25, "普林斯顿大学", "美国", "5|2|2|2|4"),
        (26, "悉尼大学", "澳大利亚", "4|3|4|4|3"),
        (27, "麦吉尔大学", "加拿大", "4|3|4|3|4"),
        (28, "巴黎文理研究大学", "法国", "5|3|3|2|5"),
        (29, "多伦多大学", "加拿大", "4|3|5|3|4"),
        (30, "复旦大学", "中国内地", "4|2|3|3|4"),
        (31, "伦敦国王学院", "英国", "4|3|4|3|4"),
        (32, "澳大利亚国立大学", "澳大利亚", "4|3|3|3|4"),
        (33, "香港中文大学", "中国香港特别行政区", "4|3|4|3|4"),
        (34, "爱丁堡大学", "英国", "4|3|3|3|5"),
        (35, "曼彻斯特大学", "英国", "4|3|4|4|3"),
        (36, "蒙纳士大学", "澳大利亚", "4|3|4|4|3"),
        (37, "东京大学", "日本", "5|3|2|4|2"),
        (38, "哥伦比亚大学", "美国", "4|3|4|3|5"),
        (39, "首尔大学", "韩国", "4|3|3|4|3"),
        (40, "不列颠哥伦比亚大学", "加拿大", "4|3|4|3|4"),
        (41, "巴黎理工学院", "法国", "5|4|2|5|1"),
        (42, "西北大学", "美国", "4|4|4|4|3"),
        (43, "昆士兰大学", "澳大利亚", "4|3|4|4|3"),
        (44, "香港科技大学", "中国香港特别行政区", "4|4|3|5|2"),
        (45, "密歇根大学安娜堡分校", "美国", "4|4|4|5|3"),
        (46, "加利福尼亚大学洛杉矶分校", "美国", "4|4|4|4|3"),
        (47, "代尔夫特理工大学", "荷兰", "5|4|2|5|2"),
        (48, "上海交通大学", "中国内地", "4|4|3|5|2"),
        (49, "浙江大学", "中国内地", "4|3|3|5|2"),
        (50, "延世大学", "韩国", "4|3|3|4|3"),
        (51, "布里斯托大学", "英国", "4|3|3|3|4"),
        (52, "卡内基梅隆大学", "美国", "4|5|2|5|2"),
        (53, "阿姆斯特丹大学", "荷兰", "4|3|4|3|4"),
        (54, "香港理工大学", "中国香港特别行政区", "4|3|4|4|3"),
        (55, "纽约大学", "美国", "4|4|5|4|3"),
        (56, "伦敦政治经济学院", "英国", "4|2|5|2|5"),
        (57, "京都大学", "日本", "5|2|2|3|4"),
        (58, "慕尼黑大学", "德国", "5|2|3|2|5"),
        (59, "马来亚大学", "马来西亚", "4|3|4|4|3"),
        (60, "鲁汶大学", "比利时", "4|3|3|3|4"),
        (61, "高丽大学", "韩国", "4|3|3|4|3"),
        (62, "杜克大学", "美国", "4|4|4|4|4"),
        (63, "香港城市大学", "中国香港特别行政区", "4|3|4|4|3"),
        (64, "台湾大学", "中国台湾", "4|3|3|3|4"),
        (65, "奥克兰大学", "新西兰", "4|3|4|3|4"),
        (66, "加利福尼亚大学圣迭戈分校", "美国", "4|4|3|4|3"),
        (67, "法赫德国王石油与矿业大学", "沙特阿拉伯", "4|4|2|5|1"),
        (68, "得克萨斯大学奥斯汀分校", "美国", "4|4|4|5|3"),
        (69, "布朗大学", "美国", "4|3|4|2|5"),
        (70, "巴黎萨克雷大学", "法国", "5|4|2|5|1"),
        (71, "伊利诺伊大学厄巴纳-香槟分校", "美国", "4|4|3|5|2"),
        (72, "隆德大学", "瑞典", "4|3|3|3|4"),
        (73, "索邦大学", "法国", "4|2|3|2|5"),
        (74, "华威大学", "英国", "4|3|4|3|4"),
        (75, "都柏林圣三一大学", "爱尔兰", "4|3|3|2|5"),
        (76, "伯明翰大学", "英国", "4|3|3|3|4"),
        (77, "西澳大学", "澳大利亚", "4|3|4|4|3"),
        (78, "皇家理工学院", "瑞典", "5|4|2|5|2"),
        (79, "格拉斯哥大学", "英国", "4|3|3|3|4"),
        (80, "海德堡大学", "德国", "5|2|2|2|5"),
        (81, "华盛顿大学", "美国", "4|4|3|4|3"),
        (82, "阿德莱德大学", "澳大利亚", "4|3|4|4|3"),
        (83, "宾夕法尼亚州立大学", "美国", "4|3|3|4|3"),
        (84, "布宜诺斯艾利斯大学", "阿根廷", "4|2|4|3|4"),
        (85, "东京工业大学", "日本", "5|4|2|5|1"),
        (86, "利兹大学", "英国", "4|3|3|3|4"),
        (87, "南安普顿大学", "英国", "4|3|3|3|4"),
        (88, "波士顿大学", "美国", "4|3|4|4|3"),
        (89, "柏林自由大学", "德国", "4|2|4|2|5"),
        (90, "普渡大学", "美国", "4|3|3|5|2"),
        (91, "大阪大学", "日本", "4|3|3|4|3"),
        (92, "谢菲尔德大学", "英国", "4|3|3|3|4"),
        (93, "乌普萨拉大学", "瑞典", "4|3|3|3|4"),
        (94, "杜伦大学", "英国", "4|2|3|2|5"),
        (95, "阿尔伯塔大学", "加拿大", "4|3|4|3|4"),
        (96, "悉尼科技大学", "澳大利亚", "4|3|4|4|3"),
        (97, "诺丁汉大学", "英国", "4|3|3|3|4"),
        (98, "卡尔斯鲁厄理工学院", "德国", "5|4|2|5|2"),
        (99, "米兰理工大学", "意大利", "4|4|2|5|2"),
        (100, "苏黎世大学", "瑞士", "5|2|3|2|4")
    ]
    c.executemany('INSERT INTO qs_schools (rank, name, country, dimensions) VALUES (?,?,?,?)', qs_schools)

    conn.commit()
    conn.close()

def calculate_match(user_dim_scores):
    conn = sqlite3.connect('school_match.db')
    c = conn.cursor()
    c.execute('SELECT rank, name, country, dimensions FROM qs_schools')
    all_schools = []
    for row in c.fetchall():
        rank, name, country, dim_str = row
        all_schools.append({
            'rank': rank,
            'name': name,
            'country': country
        })
    conn.close()

    # 真正完全公平：从 100 所里直接随机抽 5 所
    # 美国、英国、日本、新加坡、香港、澳洲、欧洲 全部均匀出现
    final = random.sample(all_schools, 5)
    return final


@app.route('/')
def index():
    conn = sqlite3.connect('school_match.db')
    c = conn.cursor()
    c.execute('SELECT id, content, options FROM questions')
    questions = []
    for row in c.fetchall():
        q_id, content, options_str = row
        options = []
        parts = options_str.split('|')
        for i in range(0, len(parts), 6):
            if i+5 < len(parts):
                options.append({
                    'content': parts[i],
                    'scores': parts[i+1:i+6]
                })
        questions.append({'id': q_id, 'content': content, 'options': options})
    conn.close()
    return render_template('index.html', questions=questions)

@app.route('/submit', methods=['POST'])
def submit():
    user = [0,0,0,0,0]
    for k, v in request.form.items():
        s = list(map(int, v.split(',')))
        for i in range(5): user[i] += s[i]
    res = calculate_match(user)
    txt = ';'.join(f"{x['rank']}|{x['name']}|{x['country']}" for x in res)
    return redirect(url_for('result', schools=txt))

@app.route('/result')
def result():
    txt = request.args.get('schools','')
    schools = []
    if txt:
        for item in txt.split(';'):
            r,n,c = item.split('|')
            schools.append({'rank':r,'name':n,'country':c})
    msg = random.choice([
        "你的性格特质与这些名校的核心气质高度契合，未来可期！",
        "这些名校的校园文化和培养理念，恰好能发挥你的性格优势～",
        "你的思维方式和价值取向，和这些顶尖学府的追求不谋而合！",
        "恭喜！这些名校就是最适合你性格发展的理想选择～",
        "你的性格优势在这些名校能得到最大程度的发挥，冲！"
    ])
    return render_template('result.html', schools=schools, comment=msg)

if __name__ == '__main__':
    if os.path.exists('school_match.db'):
        os.remove('school_match.db')
    init_db()
    app.run(host='0.0.0.0', port=5001, debug=True)
